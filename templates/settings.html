<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Settings - DeepfakeDetect</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<!-- Background Glow -->
<div class="bg-glow main-glow"></div>
<div class="bg-glow top-right-glow"></div>
<div class="bg-glow bottom-left-glow"></div>

<!-- NAVIGATION -->
<nav class="header">
    <div class="logo">
        <a href="/" class="nav-logo">
            <div class="site-icon"></div>
            <h1>DeepfakeDetect</h1>
        </a>
    </div>

    <div class="nav-links">
        <a href="/" class="nav-item">{{ t.dashboard }}</a>
        <a href="/history" class="nav-item">{{ t.history }}</a>
        <a href="/settings" class="nav-item">{{ t.settings }}</a>
    </div>

    <div class="user-profile" id="userProfileButton">
        <img src="{{ user.icon_url }}" alt="User Icon" class="user-icon">
    </div>
</nav>

<!-- PROFILE PANEL -->
<div class="profile-panel" id="profilePanel">
    <div class="profile-header">
        <img src="{{ user.icon_url }}" alt="Profile Icon" class="profile-icon">
        <div class="profile-info">
            <span class="profile-username">{{ user.username }}</span>
            <span class="profile-tagline">{{ user.tagline }}</span>
        </div>
    </div>

    <div class="profile-stats">
        <div class="stat-item">
            <span class="stat-label">{{ t.level }}</span>
            <span class="stat-value">{{ user.level }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">{{ t.uid }}</span>
            <span class="stat-value">{{ user.uid }}</span>
        </div>
    </div>

    <div class="profile-menu-grid">
        <div class="menu-item" onclick="window.location.href='/'">{{ t.dashboard }}</div>
        <div class="menu-item" onclick="window.location.href='/history'">{{ t.history }}</div>
        <div class="menu-item" onclick="window.location.href='/settings'">{{ t.settings }}</div>
        <div class="menu-item" onclick="window.location.href='/logout'">{{ t.logout }}</div>
    </div>
</div>

<main class="container">
    <section class="hero-section">
        <h1>{{ t.settings_title }}</h1>
        <p class="tagline">{{ t.settings_tagline }}</p>
    </section>

    <section class="settings-panel">
        <!-- 1. Theme Settings -->
        <div class="setting-card">
            <div class="setting-title">{{ t.theme }}</div>
            <div class="setting-description">{{ t.appearance_desc }}</div>
            
            <div class="theme-toggle-settings">
                <span class="theme-label">{{ t.dark }}</span>
                <label class="theme-toggle">
                    <input type="checkbox" id="themeToggleSettings" {{ 'checked' if theme == 'light' else '' }}>
                    <span class="theme-slider"></span>
                </label>
                <span class="theme-label">{{ t.light }}</span>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn-apply-theme" onclick="applyTheme()">{{ t.apply }}</button>
            </div>
        </div>

        <!-- 2. Language Settings -->
        <div class="setting-card">
            <div class="setting-title">{{ t.language }}</div>
            <div class="setting-description">{{ t.appearance_desc }}</div>
            
            <div class="language-switcher-settings">
                <button class="lang-btn-settings {{ 'active' if language == 'en' }}" data-lang="en">
                    English
                </button>
                <button class="lang-btn-settings {{ 'active' if language == 'vi' }}" data-lang="vi">
                    Tiếng Việt
                </button>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn-apply-lang" onclick="applyLanguage()">{{ t.apply }}</button>
            </div>
        </div>




    </section>
</main>

<script>
// Áp dụng theme khi tải trang
document.addEventListener('DOMContentLoaded', function() {
    document.documentElement.setAttribute('data-theme', '{{ theme }}');
});

/* PROFILE PANEL */
const profileButton = document.getElementById("userProfileButton");
const profilePanel = document.getElementById("profilePanel");
if (profileButton && profilePanel) {
    profileButton.addEventListener("click", () => profilePanel.classList.toggle("open"));
    document.addEventListener("click", e => {
        if (!profilePanel.contains(e.target) && !profileButton.contains(e.target)) {
            profilePanel.classList.remove("open");
        }
    });
}

/* THEME MANAGEMENT */
let selectedTheme = '{{ theme }}';

// Theme toggle change
document.getElementById('themeToggleSettings').addEventListener('change', function() {
    selectedTheme = this.checked ? "light" : "dark";
});

function applyTheme() {
    document.documentElement.setAttribute("data-theme", selectedTheme);
    saveSettings({ theme: selectedTheme });
}

/* LANGUAGE MANAGEMENT */
let selectedLanguage = '{{ language }}';

// Language button clicks
document.querySelectorAll('.lang-btn-settings').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.lang-btn-settings').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        selectedLanguage = this.getAttribute('data-lang');
    });
});

function applyLanguage() {
    saveSettings({ language: selectedLanguage }, true);
}

/* SAVE SETTINGS TO SERVER */
async function saveSettings(settings, reload = false) {
    try {
        const response = await fetch("/update_settings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(settings)
        });

        const result = await response.json();
        
        if (result.status === "success") {
            showStatus("{{ t.settings_saved }}", "success");
            
            if (reload) {
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        } else {
            showStatus("Failed to save settings", "error");
        }
    } catch (error) {
        console.error("Error saving settings:", error);
        showStatus("Error saving settings", "error");
    }
}

/* SAVE ALL SETTINGS */
async function saveAllSettings() {
    const settings = {
        theme: selectedTheme,
        language: selectedLanguage,
        notifications: document.getElementById("notifToggle").checked,
        frameCount: parseInt(document.getElementById("frameCount").value)
    };

    await saveSettings(settings, true);
}

/* STATUS MESSAGE */
function showStatus(message, type) {
    const statusEl = document.getElementById("settingStatus");
    statusEl.textContent = message;
    statusEl.className = `setting-status ${type}`;
    statusEl.style.display = 'block';
    
    setTimeout(() => {
        statusEl.style.display = 'none';
    }, 2000);
}
</script>
</body>
</html>