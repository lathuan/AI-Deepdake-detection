<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Deepfake Detection</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* CSS for explanations (English ready) */
        .feature-explanation {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid var(--accent-purple);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }
       
        .feature-explanation h4 {
            color: var(--accent-purple);
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }
       
        .feature-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
        }
       
        .feature-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 3px solid #666;
        }
       
        .feature-item.high {
            border-left-color: var(--red-fake);
            background: rgba(255, 68, 68, 0.1);
        }
       
        .feature-item.medium {
            border-left-color: #ffaa00;
            background: rgba(255, 170, 0, 0.1);
        }
       
        .feature-item.low {
            border-left-color: var(--green-real);
            background: rgba(68, 255, 68, 0.1);
        }
       
        .feature-name {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
       
        .feature-severity {
            font-size: 0.85em;
            padding: 2px 8px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
        }
       
        .feature-description {
            color: var(--text-secondary);
            font-size: 0.95em;
            line-height: 1.5;
        }
       
        .feature-confidence {
            margin-top: 5px;
            font-size: 0.9em;
            color: #999;
        }
       
        .summary-box {
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.2), rgba(75, 0, 130, 0.2));
            border: 1px solid var(--accent-purple);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            white-space: pre-line;
        }
       
        .risk-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 10px;
        }
       
        .risk-badge.high {
            background: var(--red-fake);
            color: white;
        }
       
        .risk-badge.medium {
            background: #ffaa00;
            color: black;
        }
       
        .risk-badge.low {
            background: var(--green-real);
            color: black;
        }
    </style>
</head>
<body>
    <!-- Background Glow -->
    <div class="bg-glow main-glow"></div>
    <div class="bg-glow top-right-glow"></div>
    <div class="bg-glow bottom-left-glow"></div>

    <!-- NAVBAR -->
    <nav class="header">
        <div class="logo">
            <a href="/" class="nav-logo">
                <div class="site-icon"></div>
                <h1>Deepfake AI</h1>
            </a>
        </div>
        <div class="nav-links">
            <a href="/" class="nav-item">{{ t.dashboard }}</a>
            <a href="/history" class="nav-item">{{ t.history }}</a>
            <a href="/settings" class="nav-item">{{ t.settings }}</a>
        </div>

        <div class="nav-right">
            {% if session.get("user_id") %}
                <a href="/account" class="btn-primary">Account</a>
            {% else %}
                <a href="/login" class="btn-primary">Login</a>
                <a href="/register" class="btn-primary">Register</a>
            {% endif %}
        </div>
    </nav>

    <main class="container">
        <!-- HERO SECTION -->
        <div class="hero-section">
            <h1>{{ t.hero_title }}</h1>
            <p class="tagline">{{ t.tagline }}</p>
        </div>

        <!-- UPLOAD PANEL -->
        <section class="panel upload-section">
            <h2>{{ t.upload_section }}</h2>

            <div class="input-controls">
                <label for="videoInput">{{ t.select_video }}</label>
                <input type="file" id="videoInput" class="custom-file-input" accept="video/*">
                <div id="videoInputName">{{ t.no_file }}</div>
            </div>

            <button id="uploadBtn">
                {{ t.analyze }}
                <div class="spinner" id="uploadSpinner" style="display:none;"></div>
            </button>

            <p class="instruction">{{ t.supported_formats }}</p>
        </section>

        <!-- SAVE HISTORY NOTIFICATION (hi·ªÉn th·ªã t√™n file) -->
        <div id="saveHistoryNotification" class="save-history-notification">
            <p>{{ t.save_to_history|replace('{}', '<strong><span id="notifyFilename"></span></strong>')|safe }}</p>
            <div class="notification-buttons">
                <button id="notifySaveBtn" class="btn-save">{{ t.save }}</button>
                <button id="notifyDiscardBtn" class="btn-discard">{{ t.discard }}</button>
            </div>
            <p id="notifyMessage"></p>
        </div>

        <!-- LIVE RESULT -->
        <section class="panel" id="resultSection" style="display:none;">
            <h2>{{ t.analysis_result }}</h2>

            <div class="prediction-summary" id="predictionBox">
                <h3>{{ t.prediction }}:</h3>
                <div class="prediction-value" id="predictionText"></div>
                <p id="confidenceText"></p>
            </div>

            <h4 id="timelineHeader" class="analysis-header" style="display:none;">{{ t.suspicious_timeline }}</h4>
            <img id="timelineImg" class="timeline-img" style="display:none;">

            <h4 class="analysis-header">{{ t.suspicious_frames }}</h4>
            <div id="framesGallery" class="frame-gallery"></div>
        </section>
    </main>

<script>
// √Åp d·ª•ng theme khi t·∫£i trang
document.addEventListener('DOMContentLoaded', function() {
    document.documentElement.setAttribute('data-theme', '{{ theme }}');
});

/* ELEMENTS */
const uploadBtn = document.getElementById("uploadBtn");
const videoInput = document.getElementById("videoInput");
const videoInputName = document.getElementById("videoInputName");
const uploadSpinner = document.getElementById("uploadSpinner");

const resultSection = document.getElementById("resultSection");
const predictionBox = document.getElementById("predictionBox");
const predictionText = document.getElementById("predictionText");
const confidenceText = document.getElementById("confidenceText");
const timelineHeader = document.getElementById("timelineHeader");
const timelineImg = document.getElementById("timelineImg");
const framesGallery = document.getElementById("framesGallery");

const saveHistoryNotification = document.getElementById("saveHistoryNotification");
const notifyFilename = document.getElementById("notifyFilename");
const notifySaveBtn = document.getElementById("notifySaveBtn");
const notifyDiscardBtn = document.getElementById("notifyDiscardBtn");

let currentTempId = null;
let currentFilename = '';

/* RENDER RESULTS (English labels & fallback) */
function renderResults(data) {
    console.log("Rendering results:", data);

    // Clear previous results
    framesGallery.innerHTML = '';
    timelineImg.style.display = 'none';
    timelineHeader.style.display = 'none';

    // Prediction box
    const pred = data.prediction || 'UNKNOWN';
    const conf = data.confidence || 0;
    predictionText.textContent = pred;
    predictionText.className = pred === 'FAKE' ? 'prediction-fake' : 'prediction-real';
    confidenceText.textContent = `Confidence: ${(conf * 100).toFixed(1)}%`;

    // Timeline
    if (data.timeline_base64) {
        timelineImg.src = `data:image/png;base64,${data.timeline_base64}`;
        timelineImg.style.display = 'block';
        timelineHeader.style.display = 'block';
    }

    // Frames gallery (English)
    if (data.frames_base64 && data.frames_base64.length > 0) {
        data.frames_base64.forEach((f, idx) => {
            const box = document.createElement('div');
            box.className = 'frame-box';

            // Render Summary (English)
            let summaryHTML = '';
            if (f.summary) {
                summaryHTML = `
                    <div class="summary-box">
                        <strong>üìä Summary:</strong><br>
                        ${f.summary.replace(/\n/g, '<br>')}
                        <span class="risk-badge ${f.risk_level}">${f.risk_level.toUpperCase()}</span>
                    </div>
                `;
            }

            // Render Features (English fallback)
            let featuresHTML = '';
            if (f.features && f.features.length > 0) {
                featuresHTML = `
                    <div class="feature-explanation">
                        <h4>üîç Suspicious Features (${f.num_suspicious_features})</h4>
                        <ul class="feature-list">
                            ${f.features.map(feature => `
                                <li class="feature-item ${feature.severity}">
                                    <div class="feature-name">
                                        <span>${feature.name}</span>
                                        <span class="feature-severity">${feature.severity.toUpperCase()}</span>
                                    </div>
                                    <div class="feature-description">${feature.description}</div>
                                    <div class="feature-confidence">Confidence: ${(feature.confidence * 100).toFixed(1)}%</div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            } else {
                featuresHTML = '<div class="feature-explanation"><p>No suspicious features detected.</p></div>';
            }

            box.innerHTML = `
                <p><strong>Frame ${f.frame_index}</strong></p>
               
                <div class="comp-box">
                    <h4>Detected Face</h4>
                    <img src="data:image/jpeg;base64,${f.face_base64}" class="face-img" alt="Face frame ${f.frame_index}" onerror="console.error('Failed to load face image')">
                </div>
               
                <div class="comp-box">
                    <h4>Heatmap</h4>
                    <img src="data:image/jpeg;base64,${f.heatmap_base64}" class="face-img" alt="Heatmap ${f.frame_index}" onerror="console.error('Failed to load heatmap image')">
                </div>
               
                <p class="confidence-label">Confidence: ${(f.confidence * 100).toFixed(2)}%</p>
               
                ${summaryHTML}
                ${featuresHTML}
            `;
            framesGallery.appendChild(box);
        });
    } else {
        console.log("No frames to display");
    }
}

/* UPLOAD CLICK (Gi·ªØ hi·ªÉn th·ªã t√™n file) */
uploadBtn.addEventListener("click", async () => {
    const file = videoInput.files[0];
    if (!file) {
        alert("Please select a video.");
        return;
    }

    console.log("=== UPLOAD DEBUG START ===");
    console.log("Selected file:", {
        name: file.name,
        size: file.size,
        type: file.type,
        lastModified: file.lastModified
    });

    // Ki·ªÉm tra ƒë·ªãnh d·∫°ng file
    const allowedExtensions = ['mp4', 'avi', 'mov', 'mkv', 'webm'];
    const fileExtension = file.name.split('.').pop().toLowerCase();
    
    console.log("File extension:", fileExtension);
    
    if (!allowedExtensions.includes(fileExtension)) {
        alert(`Invalid file format: .${fileExtension}. Supported: ${allowedExtensions.join(', ')}`);
        return;
    }

    // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (t·ªëi ƒëa 100MB)
    const maxSize = 100 * 1024 * 1024; // 100MB
    if (file.size > maxSize) {
        alert("File too large. Maximum size is 100MB.");
        return;
    }

    if (file.size === 0) {
        alert("File is empty. Please select a valid video file.");
        return;
    }

    uploadSpinner.style.display = "inline-block";
    uploadBtn.disabled = true;

    const form = new FormData();
    form.append("video", file);

    try {
        console.log("Starting upload...");
        
        // T·∫°o timeout controller
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            console.log("Upload timeout after 5 minutes");
            controller.abort();
        }, 300000); // 5 ph√∫t
        
        const startTime = Date.now();
        const res = await fetch("/upload", { 
            method: "POST", 
            body: form,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        const endTime = Date.now();
        console.log(`Upload request completed in ${endTime - startTime}ms`);
        console.log("Upload response status:", res.status);
        console.log("Upload response headers:", Object.fromEntries(res.headers.entries()));
        
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const data = await res.json();
        console.log("Upload response data:", data);

        uploadSpinner.style.display = "none";
        uploadBtn.disabled = false;

        if (data.error) {
            console.error("Upload failed with error:", data.error);
            alert("Upload failed: " + data.error);
            return;
        }

        console.log("Upload successful, rendering results...");
        resultSection.style.display = "block";
        renderResults(data);

        currentTempId = data.temp_id;
        currentFilename = file.name;  // L∆∞u t√™n file ƒë·ªÉ hi·ªÉn th·ªã
        notifyFilename.textContent = currentFilename;  // Hi·ªÉn th·ªã t√™n file trong notify
        saveHistoryNotification.style.display = "flex";

        console.log("=== UPLOAD DEBUG END - SUCCESS ===");

    } catch (e) {
        console.error("Upload error details:", e);
        uploadSpinner.style.display = "none";
        uploadBtn.disabled = false;
        
        if (e.name === 'AbortError') {
            alert("Upload timeout. Please try again with a smaller file or check your internet connection.");
        } else if (e.name === 'TypeError' && e.message.includes('fetch')) {
            alert("Network error. Please check your internet connection and try again.");
        } else {
            alert("Upload failed: " + e.message);
        }
        
        console.log("=== UPLOAD DEBUG END - ERROR ===");
    }
});

/* SAVE/DISCARD HISTORY */
async function handleSaveHistory(save) {
    if(!currentTempId) return;
    console.log(`Saving history: ${save ? 'SAVE' : 'DISCARD'}, temp_id: ${currentTempId}`);
    
    notifyMessage.textContent = "Processing...";
    try {
        const res = await fetch("/save_history", {
            method:"POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ temp_id: currentTempId, save })
        });
        
        console.log("Save history response status:", res.status);
        const data = await res.json();
        console.log("Save history response:", data);
        
        notifyMessage.textContent = data.message;
        setTimeout(() => {
            saveHistoryNotification.style.display = "none";
            currentTempId = null;
            notifyMessage.textContent = "";
        }, 1500);
    } catch(e) {
        console.error("Save history error:", e);
        notifyMessage.textContent = "Failed to save history.";
        setTimeout(() => {
            saveHistoryNotification.style.display = "none";
            currentTempId = null;
            notifyMessage.textContent = "";
        }, 1500);
    }
}

notifySaveBtn.addEventListener("click", () => handleSaveHistory(true));
notifyDiscardBtn.addEventListener("click", () => handleSaveHistory(false));

// Event listeners for errors
window.addEventListener('unhandledrejection', event => {
    console.error('Unhandled promise rejection:', event.reason);
});

window.addEventListener('error', event => {
    console.error('Global error:', event.error);
});

console.log("JavaScript loaded successfully");
</script>
</body>
</html>