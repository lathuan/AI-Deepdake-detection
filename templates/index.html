<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Deepfake Detection</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Background Glow -->
    <div class="bg-glow main-glow"></div>
    <div class="bg-glow top-right-glow"></div>
    <div class="bg-glow bottom-left-glow"></div>

    <!-- NAVBAR -->
    <nav class="header">
        <div class="logo">
            <a href="/" class="nav-logo">
                <div class="site-icon"></div>
                <h1>Deepfake AI</h1>
            </a>
        </div>
        <div class="nav-links">
            <a href="/" class="nav-item">{{ t.dashboard }}</a>
            <a href="/history" class="nav-item">{{ t.history }}</a>
            <a href="/settings" class="nav-item">{{ t.settings }}</a>
        </div>

        <div class="nav-right">
            {% if session.get("user_id") %}
                <a href="/account" class="btn-primary">Account</a>
            {% else %}
                <a href="/login" class="btn-primary">Login</a>
                <a href="/register" class="btn-primary">Register</a>
            {% endif %}
        </div>
    </nav>

    <main class="container">
        <!-- HERO SECTION -->
        <div class="hero-section">
            <h1>{{ t.hero_title }}</h1>
            <p class="tagline">{{ t.tagline }}</p>
        </div>

        <!-- UPLOAD PANEL -->
        <section class="panel upload-section">
            <h2>{{ t.upload_section }}</h2>

            <div class="input-controls">
                <label for="videoInput">{{ t.select_video }}</label>
                <input type="file" id="videoInput" class="custom-file-input" accept="video/*">
                <div id="videoInputName">{{ t.no_file }}</div>
            </div>

            <button id="uploadBtn">
                {{ t.analyze }}
                <div class="spinner" id="uploadSpinner" style="display:none;"></div>
            </button>

            <p class="instruction">{{ t.supported_formats }}</p>
        </section>

        <!-- SAVE HISTORY NOTIFICATION -->
        <div id="saveHistoryNotification" class="save-history-notification">
            <p>{{ t.save_to_history|replace('{}', '<strong><span id="notifyFilename"></span></strong>')|safe }}</p>
            <div class="notification-buttons">
                <button id="notifySaveBtn" class="btn-save">{{ t.save }}</button>
                <button id="notifyDiscardBtn" class="btn-discard">{{ t.discard }}</button>
            </div>
            <p id="notifyMessage"></p>
        </div>

        <!-- LIVE RESULT (from new prediction) -->
        <section class="panel" id="resultSection" style="display:none;">
            <h2>{{ t.analysis_result }}</h2>

            <div class="prediction-summary" id="predictionBox">
                <h3>{{ t.prediction }}:</h3>
                <div class="prediction-value" id="predictionText"></div>
                <p id="confidenceText"></p>
            </div>

            <h4 id="timelineHeader" class="analysis-header" style="display:none;">{{ t.suspicious_timeline }}</h4>
            <img id="timelineImg" class="timeline-img" style="display:none;">

            <h4 class="analysis-header">{{ t.suspicious_frames }}</h4>
            <div id="framesGallery" class="frame-gallery"></div>
        </section>
    </main>

<script>
// Áp dụng theme khi tải trang
document.addEventListener('DOMContentLoaded', function() {
    document.documentElement.setAttribute('data-theme', '{{ theme }}');
});

/* ELEMENTS */
const uploadBtn = document.getElementById("uploadBtn");
const videoInput = document.getElementById("videoInput");
const videoInputName = document.getElementById("videoInputName");
const uploadSpinner = document.getElementById("uploadSpinner");

const resultSection = document.getElementById("resultSection");
const predictionBox = document.getElementById("predictionBox");
const predictionText = document.getElementById("predictionText");
const confidenceText = document.getElementById("confidenceText");
const timelineHeader = document.getElementById("timelineHeader");
const timelineImg = document.getElementById("timelineImg");
const framesGallery = document.getElementById("framesGallery");

const saveHistoryNotification = document.getElementById("saveHistoryNotification");
const notifyFilename = document.getElementById("notifyFilename");
const notifySaveBtn = document.getElementById("notifySaveBtn");
const notifyDiscardBtn = document.getElementById("notifyDiscardBtn");
const notifyMessage = document.getElementById("notifyMessage");

let currentTempId = null;
let currentFilename = null;

/* FILE SELECT */
videoInput.addEventListener("change", () => {
    const f = videoInput.files[0];
    videoInputName.textContent = f ? f.name : "{{ t.no_file }}";
    currentFilename = f ? f.name : null;
    console.log("File selected:", f ? {name: f.name, size: f.size, type: f.type} : "No file");
});

/* RENDER RESULT */
function renderResults(data) {
    console.log("Rendering results:", data);
    
    const isFake = data.prediction === "FAKE";
    predictionBox.style.borderColor = isFake ? "var(--red-fake)" : "var(--green-real)";
    predictionBox.style.boxShadow = `0 0 15px ${isFake ? "var(--red-fake)" : "var(--green-real)"}`;

    predictionText.textContent = data.prediction;
    predictionText.className = `prediction-value ${isFake ? "fake" : "real"}`;

    confidenceText.textContent = `{{ t.confidence }}: ${(data.confidence * 100).toFixed(2)}%`;

    /* TIMELINE */
    if (data.timeline_base64) {
        timelineImg.src = "data:image/png;base64," + data.timeline_base64;
        timelineImg.style.display = "block";
        timelineHeader.style.display = "block";
        console.log("Timeline image loaded");
    }

    /* FRAMES */
    framesGallery.innerHTML = "";
    if (data.frames_base64 && data.frames_base64.length > 0) {
        console.log(`Rendering ${data.frames_base64.length} frames`);
        data.frames_base64.forEach(f => {
            const box = document.createElement("div");
            box.className = "frame-item";
            box.style.borderColor = f.is_suspicious ? "var(--red-fake)" : "var(--accent-purple)";

            box.innerHTML = `
                <p>Frame ${f.frame_index}</p>
                <div class="comp-box">
                    <h4>{{ t.detected_face }}</h4>
                    <img src="data:image/jpeg;base64,${f.face_base64}" class="face-img" onerror="console.error('Failed to load face image')">
                </div>
                <div class="comp-box">
                    <h4>{{ t.heatmap }}</h4>
                    <img src="data:image/jpeg;base64,${f.heatmap_base64}" class="face-img" onerror="console.error('Failed to load heatmap image')">
                </div>
                <p class="confidence-label">{{ t.confidence }}: ${(f.confidence * 100).toFixed(2)}%</p>
            `;
            framesGallery.appendChild(box);
        });
    } else {
        console.log("No frames to display");
    }
}

/* UPLOAD CLICK - DEBUG VERSION */
uploadBtn.addEventListener("click", async () => {
    const file = videoInput.files[0];
    if (!file) {
        alert("Please select a video.");
        return;
    }

    console.log("=== UPLOAD DEBUG START ===");
    console.log("Selected file:", {
        name: file.name,
        size: file.size,
        type: file.type,
        lastModified: file.lastModified
    });

    // Kiểm tra định dạng file
    const allowedExtensions = ['mp4', 'avi', 'mov', 'mkv', 'webm'];
    const fileExtension = file.name.split('.').pop().toLowerCase();
    
    console.log("File extension:", fileExtension);
    
    if (!allowedExtensions.includes(fileExtension)) {
        alert(`Invalid file format: .${fileExtension}. Supported: ${allowedExtensions.join(', ')}`);
        return;
    }

    // Kiểm tra kích thước file (tối đa 100MB)
    const maxSize = 100 * 1024 * 1024; // 100MB
    if (file.size > maxSize) {
        alert("File too large. Maximum size is 100MB.");
        return;
    }

    if (file.size === 0) {
        alert("File is empty. Please select a valid video file.");
        return;
    }

    uploadSpinner.style.display = "inline-block";
    uploadBtn.disabled = true;

    const form = new FormData();
    form.append("video", file);

    try {
        console.log("Starting upload...");
        
        // Tạo timeout controller
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
            console.log("Upload timeout after 5 minutes");
            controller.abort();
        }, 300000); // 5 phút
        
        const startTime = Date.now();
        const res = await fetch("/upload", { 
            method: "POST", 
            body: form,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        const endTime = Date.now();
        console.log(`Upload request completed in ${endTime - startTime}ms`);
        console.log("Upload response status:", res.status);
        console.log("Upload response headers:", Object.fromEntries(res.headers.entries()));
        
        if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const data = await res.json();
        console.log("Upload response data:", data);

        uploadSpinner.style.display = "none";
        uploadBtn.disabled = false;

        if (data.error) {
            console.error("Upload failed with error:", data.error);
            alert("Upload failed: " + data.error);
            return;
        }

        console.log("Upload successful, rendering results...");
        resultSection.style.display = "block";
        renderResults(data);

        currentTempId = data.temp_id;
        notifyFilename.textContent = currentFilename;
        saveHistoryNotification.style.display = "flex";

        console.log("=== UPLOAD DEBUG END - SUCCESS ===");

    } catch (e) {
        console.error("Upload error details:", e);
        uploadSpinner.style.display = "none";
        uploadBtn.disabled = false;
        
        if (e.name === 'AbortError') {
            alert("Upload timeout. Please try again with a smaller file or check your internet connection.");
        } else if (e.name === 'TypeError' && e.message.includes('fetch')) {
            alert("Network error. Please check your internet connection and try again.");
        } else {
            alert("Upload failed: " + e.message);
        }
        
        console.log("=== UPLOAD DEBUG END - ERROR ===");
    }
});

/* SAVE/DISCARD HISTORY */
async function handleSaveHistory(save) {
    if(!currentTempId) return;
    console.log(`Saving history: ${save ? 'SAVE' : 'DISCARD'}, temp_id: ${currentTempId}`);
    
    notifyMessage.textContent = "Processing...";
    try {
        const res = await fetch("/save_history", {
            method:"POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ temp_id: currentTempId, save })
        });
        
        console.log("Save history response status:", res.status);
        const data = await res.json();
        console.log("Save history response:", data);
        
        notifyMessage.textContent = data.message;
        setTimeout(() => {
            saveHistoryNotification.style.display = "none";
            currentTempId = null;
            notifyMessage.textContent = "";
        }, 1500);
    } catch(e) {
        console.error("Save history error:", e);
        notifyMessage.textContent = "Failed to save history.";
        setTimeout(() => {
            saveHistoryNotification.style.display = "none";
            currentTempId = null;
            notifyMessage.textContent = "";
        }, 1500);
    }
}

notifySaveBtn.addEventListener("click", () => handleSaveHistory(true));
notifyDiscardBtn.addEventListener("click", () => handleSaveHistory(false));

// Thêm event listener để theo dõi network errors
window.addEventListener('unhandledrejection', event => {
    console.error('Unhandled promise rejection:', event.reason);
});

window.addEventListener('error', event => {
    console.error('Global error:', event.error);
});

console.log("JavaScript loaded successfully");
</script>
</body>
</html>