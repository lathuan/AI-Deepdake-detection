<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Deepfake Detection</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://www.google.com/recaptcha/api.js?hl=vi&render=explicit" async defer></script>
</head>
<body>
    <!-- Background Elements -->
    <div class="bg-glow main-glow"></div>
    <div class="bg-glow top-right-glow"></div>
    <div class="bg-glow bottom-left-glow"></div>

    <div class="auth-container">
        <div class="auth-card">
            <!-- Header -->
            <div class="auth-header">
                <div class="auth-logo">CREATE ACCOUNT</div>
                <div class="auth-subtitle">Join our deepfake detection platform</div>
            </div>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                <div class="flash-modern flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            <!-- Error Box -->
            <div class="flash-modern flash-error" id="errorBox" style="display: none;"></div>

            <!-- Register Form -->
            <form method="POST" action="{{ url_for('register') }}" id="registerForm">
                <!-- Name -->
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" name="name" class="form-input" placeholder="Enter your full name" required>
                </div>

                <!-- Email -->
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" name="email" class="form-input" placeholder="Enter your email" required>
                </div>

                <!-- Password -->
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" name="password" id="password" class="form-input" placeholder="Create a strong password" required>
                    
                    <!-- Password Strength -->
                    <div class="password-strength">
                        <div class="strength-bar" id="strengthBar"></div>
                    </div>
                    
                    <!-- Password Hints -->
                    <div class="password-hints" id="passwordHints">
                        <span id="lengthHint">• At least 8 characters</span>
                        <span id="upperHint">• One uppercase letter</span>
                        <span id="specialHint">• One special character</span>
                    </div>
                </div>

                <!-- reCAPTCHA Container -->
                <div class="form-group">
                    <label class="form-label">Xác Nhận Bạn Không Phải Robot</label>
                    <div id="recaptcha-container" class="recaptcha-modern"></div>
                    <input type="hidden" name="g-recaptcha-response" id="recaptcha-response">
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn-submit" id="registerBtn" disabled>Create Account</button>
            </form>

            <!-- Divider -->
            <div class="auth-divider">
                <span>Or sign up with</span>
            </div>

            <!-- OAuth -->
            <a href="{{ url_for('auth_google') }}" class="btn-oauth">
                <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google">
                Continue with Google
            </a>

            <!-- Links -->
            <div class="auth-links">
                <span style="color: var(--text-subtle);">Already have an account? </span>
                <a href="{{ url_for('login') }}" class="auth-link">Sign in</a>
            </div>
        </div>
    </div>

    <script>
        let recaptchaWidgetId;

        // Render reCAPTCHA
        function renderRecaptcha() {
            recaptchaWidgetId = grecaptcha.render('recaptcha-container', {
                'sitekey': '6LdZ9B8sAAAAAJNngdrks1DlcNbwur7y73sk-p0_',
                'theme': 'dark',
                'callback': onRecaptchaSuccess,
                'expired-callback': onRecaptchaExpired
            });
        }

        function onRecaptchaSuccess(token) {
            document.getElementById('recaptcha-response').value = token;
            checkFormReady();  // Kiểm tra xem form có ready không
        }

        function onRecaptchaExpired() {
            document.getElementById('recaptcha-response').value = '';
            document.getElementById('registerBtn').disabled = true;
            document.getElementById('registerBtn').classList.remove('btn-ready');
            grecaptcha.reset(recaptchaWidgetId);
        }

        // Kiểm tra form ready (password strong + CAPTCHA OK)
        function checkFormReady() {
            const password = document.getElementById('password').value;
            const response = document.getElementById('recaptcha-response').value;
            const btn = document.getElementById('registerBtn');
            
            const isPasswordStrong = password.length >= 8 && /[A-Z]/.test(password) && /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
            const isCaptchaOk = !!response;
            
            if (isPasswordStrong && isCaptchaOk) {
                btn.disabled = false;
                btn.classList.add('btn-ready');
            } else {
                btn.disabled = true;
                btn.classList.remove('btn-ready');
            }
        }

        // Password strength indicator
        const passwordInput = document.getElementById('password');
        const strengthBar = document.getElementById('strengthBar');
        const errorBox = document.getElementById('errorBox');
        
        // Password hints elements
        const lengthHint = document.getElementById('lengthHint');
        const upperHint = document.getElementById('upperHint');
        const specialHint = document.getElementById('specialHint');

        passwordInput.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            
            // Length check
            if (password.length >= 8) {
                strength += 1;
                lengthHint.classList.add('valid');
            } else {
                lengthHint.classList.remove('valid');
            }
            
            // Uppercase check
            if (/[A-Z]/.test(password)) {
                strength += 1;
                upperHint.classList.add('valid');
            } else {
                upperHint.classList.remove('valid');
            }
            
            // Special character check
            if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                strength += 1;
                specialHint.classList.add('valid');
            } else {
                specialHint.classList.remove('valid');
            }
            
            // Update strength bar
            strengthBar.className = 'strength-bar';
            if (strength === 1) {
                strengthBar.classList.add('strength-weak');
            } else if (strength === 2) {
                strengthBar.classList.add('strength-medium');
            } else if (strength === 3) {
                strengthBar.classList.add('strength-strong');
            }

            // Kiểm tra form ready sau khi thay đổi password
            checkFormReady();
        });

        // Form validation
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            const password = passwordInput.value;
            const response = document.getElementById('recaptcha-response').value;
            let errors = [];
            
            if (password.length < 8) {
                errors.push("Password must be at least 8 characters long");
            }
            if (!/[A-Z]/.test(password)) {
                errors.push("Password must contain at least one uppercase letter");
            }
            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                errors.push("Password must contain at least one special character");
            }
            if (!response) {
                errors.push("Please complete the CAPTCHA verification");
            }
            
            if (errors.length > 0) {
                e.preventDefault();
                errorBox.style.display = 'block';
                errorBox.innerHTML = errors.join('<br>');
                
                // Scroll to error
                errorBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return false;
            } else {
                // Show loading state
                const btn = document.getElementById('registerBtn');
                btn.classList.add('btn-loading');
                btn.innerHTML = 'Creating Account...';
            }
        });

        // Load recaptcha
        window.onload = function() {
            if (typeof grecaptcha !== 'undefined') {
                renderRecaptcha();
            } else {
                setTimeout(renderRecaptcha, 1000);
            }
        };

        // Input focus effects
        const inputs = document.querySelectorAll('.form-input');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.style.background = 'var(--bg-secondary)';
            });
            input.addEventListener('blur', function() {
                this.style.background = 'var(--bg-tertiary)';
            });
        });
    </script>
</body>
</html>