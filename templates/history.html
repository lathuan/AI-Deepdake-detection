<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis History</title>
    <link rel="stylesheet" href="../static/style.css">
</head>
<body>
    <div class="bg-glow main-glow"></div>
    <div class="bg-glow top-right-glow"></div>
    <div class="bg-glow bottom-left-glow"></div>

    <nav class="header">
        <div class="logo">
            <a href="/" class="nav-logo">
                <div class="site-icon"></div>
                <h1>Deepfake AI</h1>
            </a>
        </div>
        <div class="nav-links">
            <a href="/" class="nav-item">{{ t.dashboard }}</a>
            <a href="/history" class="nav-item">{{ t.history }}</a>
            <a href="/settings" class="nav-item">{{ t.settings }}</a>
        </div>
        <div class="user-profile" id="userProfileButton">
            <img src="{{ user.icon_url }}" alt="Profile Icon" class="user-icon">
        </div>
    </nav>
    
    <div class="profile-panel" id="profilePanel">
        <div class="profile-header">
            <img src="{{ user.icon_url }}" alt="Profile Icon" class="profile-icon">
            <div class="profile-info">
                <span class="profile-username">{{ user.username }}</span>
                <span class="profile-tagline">{{ user.tagline }}</span>
            </div>
        </div>
        <div class="profile-stats">
            <div class="stat-item">
                <span class="stat-label">{{ t.level }}</span>
                <span class="stat-value">{{ user.level }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">{{ t.uid }}</span>
                <span class="stat-value">{{ user.uid }}</span>
            </div>
        </div>
        <div class="profile-menu-grid">
            <div class="menu-item" onclick="window.location.href='/settings'">{{ t.settings }}</div>
            <div class="menu-item" onclick="window.location.href='/logout'">{{ t.logout }}</div>
        </div>
    </div>

    <main class="container">
        <div class="hero-section">
            <h1>{{ t.analysis_history }}</h1>
            <p class="tagline">{{ t.review_results }}</p>
        </div>
        
        <section class="panel">
            <!-- History Controls -->
            <div class="history-controls">
                <div class="history-stats">
                    {{ t.saved_results }}: <strong>{{ history|length }}</strong> {{ t.entries }}
                </div>
                {% if history %}
                <div class="history-actions">
                    <button class="btn-clear-all" onclick="showClearAllConfirm()">
                        {{ t.clear_all }}
                    </button>
                </div>
                {% endif %}
            </div>

            <div class="history-list">
                {% if history %}
                    {% for item in history %}
                    <div class="history-item" id="history-item-{{ loop.index0 }}">
                        <div class="history-item-header">
                            <div class="header-info">
                                <span class="header-filename">{{ item.filename }}</span>
                                <span class="header-date">{{ t.analyzed }}: {{ item.date }}</span>
                            </div>
                            <div class="header-actions">
                                <span class="header-prediction {{ item.prediction|lower }}">
                                    {{ item.prediction }}
                                </span>
                                <button class="btn-delete-item" 
                                        data-index="{{ loop.index0 }}" 
                                        data-filename="{{ item.filename }}">
                                    {{ t.delete }}
                                </button>
                            </div>
                        </div>

                        <div class="history-detail">
                            <p><strong>{{ t.confidence }}:</strong> {{ (item.confidence*100)|round(2) }}%</p>

                            {% if item.timeline_base64 %}
                                <h4 class="analysis-header">{{ t.suspicious_timeline }}</h4>
                                <img src="data:image/png;base64,{{ item.timeline_base64 }}" class="timeline-img" alt="Confidence Timeline">
                            {% else %}
                                <p class="text-secondary">{{ t.no_timeline }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-history">
                        <div class="empty-history-icon">üìä</div>
                        <h3>{{ t.no_history }}</h3>
                        <p>{{ t.no_history_desc }}</p>
                    </div>
                {% endif %}
            </div>
        </section>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="delete-confirm-modal">
        <div class="modal-warning-icon">‚ö†Ô∏è</div>
        <h3 id="deleteModalTitle">{{ t.confirm_delete }}</h3>
        <p id="deleteModalMessage"></p>
        <div class="modal-buttons">
            <button id="confirmDeleteBtn" class="btn-confirm-delete">{{ t.yes_delete }}</button>
            <button id="cancelDeleteBtn" class="btn-cancel-delete">{{ t.cancel }}</button>
        </div>
    </div>

    <!-- Clear All Confirmation Modal -->
    <div id="clearAllConfirmModal" class="delete-confirm-modal">
        <div class="modal-warning-icon">üö®</div>
        <h3>{{ t.confirm_clear_all }}</h3>
        <p>{{ t.clear_all_warning }}</p>
        <div class="modal-buttons">
            <button id="confirmClearAllBtn" class="btn-confirm-delete">{{ t.yes_clear_all }}</button>
            <button id="cancelClearAllBtn" class="btn-cancel-delete">{{ t.cancel }}</button>
        </div>
    </div>
    
    <script>
        // √Åp d·ª•ng theme khi t·∫£i trang
        document.addEventListener('DOMContentLoaded', function() {
            document.documentElement.setAttribute('data-theme', '{{ theme }}');
        });

        /* Toggle Profile */
        const profileButton = document.getElementById("userProfileButton");
        const profilePanel = document.getElementById("profilePanel");

        if (profileButton && profilePanel) {
            profileButton.addEventListener("click", ()=> {
                profilePanel.classList.toggle("open");
            });
            document.addEventListener("click", e=>{
                if(!profilePanel.contains(e.target) && !profileButton.contains(e.target)){
                    profilePanel.classList.remove("open");
                }
            });
        }

        /* ===== DELETE FUNCTIONALITY ===== */
        let currentDeleteIndex = null;

        // S·ª≠ d·ª•ng event delegation cho n√∫t delete
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-delete-item')) {
                const index = e.target.getAttribute('data-index');
                const filename = e.target.getAttribute('data-filename');
                showDeleteConfirm(parseInt(index), filename);
                e.stopPropagation(); // NgƒÉn s·ª± ki·ªán click lan ra history item
            }
        });

        function showDeleteConfirm(index, filename) {
            currentDeleteIndex = index;
            const modal = document.getElementById('deleteConfirmModal');
            const message = document.getElementById('deleteModalMessage');
            
            message.textContent = `{{ t.delete_item_confirm }}`.replace('{}', `"${filename}"`);
            modal.style.display = 'flex';
        }

        function showClearAllConfirm() {
            const modal = document.getElementById('clearAllConfirmModal');
            modal.style.display = 'flex';
        }

        // Delete single item
        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            if (currentDeleteIndex === null) return;
            
            try {
                const response = await fetch('/delete_history_item', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index: currentDeleteIndex })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Remove item from UI
                    const itemElement = document.getElementById(`history-item-${currentDeleteIndex}`);
                    if (itemElement) {
                        itemElement.style.transition = 'all 0.3s ease';
                        itemElement.style.opacity = '0';
                        itemElement.style.transform = 'translateX(-100px)';
                        setTimeout(() => {
                            itemElement.remove();
                            updateHistoryUI();
                        }, 300);
                    }
                } else {
                    alert('Error deleting item: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                alert('Error deleting item');
            }
            
            document.getElementById('deleteConfirmModal').style.display = 'none';
            currentDeleteIndex = null;
        });

        // Clear all history
        document.getElementById('confirmClearAllBtn').addEventListener('click', async function() {
            try {
                const response = await fetch('/clear_all_history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Fade out all items
                    document.querySelectorAll('.history-item').forEach((item, index) => {
                        item.style.transition = `all 0.3s ease ${index * 0.1}s`;
                        item.style.opacity = '0';
                        item.style.transform = 'translateX(-100px)';
                    });
                    
                    setTimeout(() => {
                        updateHistoryUI();
                    }, 500);
                } else {
                    alert('Error clearing history: ' + result.message);
                }
            } catch (error) {
                console.error('Error clearing history:', error);
                alert('Error clearing history');
            }
            
            document.getElementById('clearAllConfirmModal').style.display = 'none';
        });

        // Update UI after deletion
        function updateHistoryUI() {
            const historyItems = document.querySelectorAll('.history-item');
            const historyStats = document.querySelector('.history-stats');
            const historyActions = document.querySelector('.history-actions');
            const historyList = document.querySelector('.history-list');
            
            if (historyItems.length === 0) {
                // Show empty state
                historyList.innerHTML = `
                    <div class="empty-history">
                        <div class="empty-history-icon">üìä</div>
                        <h3>{{ t.no_history }}</h3>
                        <p>{{ t.no_history_desc }}</p>
                    </div>
                `;
                if (historyActions) {
                    historyActions.style.display = 'none';
                }
            }
            
            // Update stats
            if (historyStats) {
                historyStats.innerHTML = `{{ t.saved_results }}: <strong>${historyItems.length}</strong> {{ t.entries }}`;
            }
        }

        // Cancel buttons
        document.getElementById('cancelDeleteBtn').addEventListener('click', function() {
            document.getElementById('deleteConfirmModal').style.display = 'none';
            currentDeleteIndex = null;
        });

        document.getElementById('cancelClearAllBtn').addEventListener('click', function() {
            document.getElementById('clearAllConfirmModal').style.display = 'none';
        });

        // Close modals when clicking outside
        window.addEventListener('click', function(e) {
            const deleteModal = document.getElementById('deleteConfirmModal');
            const clearAllModal = document.getElementById('clearAllConfirmModal');
            
            if (e.target === deleteModal) {
                deleteModal.style.display = 'none';
                currentDeleteIndex = null;
            }
            
            if (e.target === clearAllModal) {
                clearAllModal.style.display = 'none';
            }
        });

        /* ===== HISTORY TOGGLE ===== */
        document.querySelectorAll('.history-item-header').forEach(header => {
            header.addEventListener('click', function(e) {
                // Kh√¥ng toggle n·∫øu click v√†o n√∫t delete
                if (e.target.classList.contains('btn-delete-item')) {
                    return;
                }
                
                const detail = this.nextElementSibling;
                if (detail.style.display === 'block') {
                    detail.style.display = 'none';
                    this.style.borderBottom = '1px solid transparent';
                } else {
                    detail.style.display = 'block';
                    this.style.borderBottom = '1px solid var(--blue-cobalt)';
                }
            });
        });
    </script>
</body>
</html>